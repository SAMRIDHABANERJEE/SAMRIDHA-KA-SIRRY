<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Samridha's Sirry</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@400;700;900&family=Rajdhani:wght@300;400;500;600;700&family=Orbitron:wght@400;500;700;900&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #020408;
    --surface: #050d18;
    --accent1: #00f0ff;
    --accent2: #ff006e;
    --accent3: #7b2fff;
    --gold: #ffd700;
    --text: #e0f7ff;
    --muted: #5a8a9f;
    --glow1: 0 0 20px rgba(0,240,255,0.6), 0 0 60px rgba(0,240,255,0.2);
    --glow2: 0 0 20px rgba(255,0,110,0.6), 0 0 60px rgba(255,0,110,0.2);
    --glow3: 0 0 20px rgba(123,47,255,0.6), 0 0 60px rgba(123,47,255,0.2);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Rajdhani', sans-serif;
    min-height: 100vh;
    overflow-x: hidden;
    position: relative;
  }

  /* Animated background */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background: 
      radial-gradient(ellipse 60% 40% at 20% 20%, rgba(0,240,255,0.07) 0%, transparent 60%),
      radial-gradient(ellipse 50% 50% at 80% 80%, rgba(123,47,255,0.08) 0%, transparent 60%),
      radial-gradient(ellipse 40% 30% at 50% 50%, rgba(255,0,110,0.04) 0%, transparent 60%);
    pointer-events: none;
    z-index: 0;
    animation: bgPulse 8s ease-in-out infinite alternate;
  }

  @keyframes bgPulse {
    0% { opacity: 0.8; }
    100% { opacity: 1.2; }
  }

  /* Grid lines */
  body::after {
    content: '';
    position: fixed;
    inset: 0;
    background-image: 
      linear-gradient(rgba(0,240,255,0.03) 1px, transparent 1px),
      linear-gradient(90deg, rgba(0,240,255,0.03) 1px, transparent 1px);
    background-size: 60px 60px;
    pointer-events: none;
    z-index: 0;
  }

  .container {
    position: relative;
    z-index: 1;
    max-width: 900px;
    margin: 0 auto;
    padding: 30px 20px;
    display: flex;
    flex-direction: column;
    min-height: 100vh;
  }

  /* Header */
  .header {
    text-align: center;
    margin-bottom: 40px;
    animation: fadeDown 1s ease-out;
  }

  @keyframes fadeDown {
    from { opacity: 0; transform: translateY(-30px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .header-badge {
    display: inline-block;
    font-family: 'Orbitron', sans-serif;
    font-size: 0.65rem;
    letter-spacing: 4px;
    color: var(--accent1);
    text-transform: uppercase;
    margin-bottom: 12px;
    padding: 4px 16px;
    border: 1px solid rgba(0,240,255,0.3);
    border-radius: 20px;
    background: rgba(0,240,255,0.05);
  }

  .header h1 {
    font-family: 'Cinzel Decorative', cursive;
    font-size: clamp(1.8rem, 5vw, 3.2rem);
    font-weight: 900;
    background: linear-gradient(135deg, var(--accent1) 0%, var(--accent3) 50%, var(--accent2) 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    line-height: 1.2;
    margin-bottom: 8px;
    filter: drop-shadow(0 0 30px rgba(0,240,255,0.4));
  }

  .header p {
    font-family: 'Rajdhani', sans-serif;
    color: var(--muted);
    font-size: 1rem;
    letter-spacing: 2px;
    text-transform: uppercase;
    font-weight: 500;
  }

  /* Orb / Visualizer */
  .orb-container {
    display: flex;
    justify-content: center;
    margin: 10px 0 30px;
    animation: fadeIn 1.5s ease-out;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: scale(0.8); }
    to { opacity: 1; transform: scale(1); }
  }

  .orb {
    width: 160px;
    height: 160px;
    border-radius: 50%;
    position: relative;
    cursor: pointer;
    transition: transform 0.3s ease;
  }

  .orb:hover { transform: scale(1.05); }

  .orb-inner {
    position: absolute;
    inset: 0;
    border-radius: 50%;
    background: radial-gradient(circle at 35% 35%, rgba(0,240,255,0.3), rgba(123,47,255,0.5) 50%, rgba(255,0,110,0.2));
    box-shadow: 
      0 0 40px rgba(0,240,255,0.4),
      0 0 80px rgba(123,47,255,0.3),
      inset 0 0 40px rgba(0,240,255,0.1);
    animation: orbIdle 4s ease-in-out infinite;
  }

  @keyframes orbIdle {
    0%, 100% { box-shadow: 0 0 40px rgba(0,240,255,0.4), 0 0 80px rgba(123,47,255,0.3), inset 0 0 40px rgba(0,240,255,0.1); }
    50% { box-shadow: 0 0 60px rgba(0,240,255,0.6), 0 0 120px rgba(123,47,255,0.5), inset 0 0 60px rgba(0,240,255,0.2); }
  }

  .orb-ring {
    position: absolute;
    border-radius: 50%;
    border: 1px solid rgba(0,240,255,0.3);
    animation: ringExpand 3s ease-out infinite;
  }

  .orb-ring:nth-child(2) { inset: -15px; animation-delay: 0s; }
  .orb-ring:nth-child(3) { inset: -30px; animation-delay: 1s; }
  .orb-ring:nth-child(4) { inset: -45px; animation-delay: 2s; }

  @keyframes ringExpand {
    0% { opacity: 0.6; transform: scale(1); }
    100% { opacity: 0; transform: scale(1.1); }
  }

  .orb-icon {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 3rem;
    z-index: 2;
    text-shadow: 0 0 20px rgba(0,240,255,0.8);
  }

  /* Listening / Speaking animations */
  .orb.listening .orb-inner {
    animation: orbListen 0.5s ease-in-out infinite alternate;
    background: radial-gradient(circle at 35% 35%, rgba(255,0,110,0.4), rgba(123,47,255,0.5) 50%, rgba(255,0,110,0.3));
    box-shadow: 0 0 60px rgba(255,0,110,0.6), 0 0 120px rgba(255,0,110,0.4), inset 0 0 40px rgba(255,0,110,0.2);
  }

  @keyframes orbListen {
    from { transform: scale(0.95); }
    to { transform: scale(1.05); }
  }

  .orb.speaking .orb-inner {
    animation: orbSpeak 0.3s ease-in-out infinite alternate;
    background: radial-gradient(circle at 35% 35%, rgba(0,240,255,0.5), rgba(0,200,255,0.4) 50%, rgba(123,47,255,0.3));
    box-shadow: 0 0 80px rgba(0,240,255,0.8), 0 0 150px rgba(0,240,255,0.4), inset 0 0 60px rgba(0,240,255,0.3);
  }

  @keyframes orbSpeak {
    from { transform: scale(0.97); }
    to { transform: scale(1.03); }
  }

  /* Status */
  .status-bar {
    text-align: center;
    margin-bottom: 25px;
    font-family: 'Orbitron', sans-serif;
    font-size: 0.75rem;
    letter-spacing: 3px;
    text-transform: uppercase;
  }

  .status-dot {
    display: inline-block;
    width: 8px; height: 8px;
    border-radius: 50%;
    background: var(--muted);
    margin-right: 8px;
    vertical-align: middle;
    transition: all 0.3s ease;
  }

  .status-dot.ready { background: var(--accent1); box-shadow: var(--glow1); animation: blink 2s ease-in-out infinite; }
  .status-dot.listening { background: var(--accent2); box-shadow: var(--glow2); animation: blink 0.5s ease-in-out infinite; }
  .status-dot.thinking { background: var(--gold); box-shadow: 0 0 20px rgba(255,215,0,0.6); animation: blink 0.8s ease-in-out infinite; }
  .status-dot.speaking { background: #00ff88; box-shadow: 0 0 20px rgba(0,255,136,0.6); animation: blink 0.3s ease-in-out infinite; }

  @keyframes blink {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.3; }
  }

  .status-text { color: var(--muted); transition: color 0.3s ease; }
  .status-text.active { color: var(--accent1); }

  /* Chat Area */
  .chat-area {
    flex: 1;
    border: 1px solid rgba(0,240,255,0.15);
    border-radius: 16px;
    background: rgba(5,13,24,0.8);
    backdrop-filter: blur(10px);
    padding: 20px;
    margin-bottom: 20px;
    min-height: 250px;
    max-height: 380px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 16px;
    box-shadow: inset 0 0 30px rgba(0,240,255,0.03), 0 0 30px rgba(0,240,255,0.05);
  }

  .chat-area::-webkit-scrollbar { width: 4px; }
  .chat-area::-webkit-scrollbar-track { background: transparent; }
  .chat-area::-webkit-scrollbar-thumb { background: rgba(0,240,255,0.3); border-radius: 2px; }

  .message {
    display: flex;
    gap: 12px;
    align-items: flex-start;
    animation: msgIn 0.4s ease-out;
  }

  @keyframes msgIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .message.user { flex-direction: row-reverse; }

  .msg-avatar {
    width: 36px; height: 36px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.1rem;
    flex-shrink: 0;
  }

  .user .msg-avatar {
    background: rgba(255,0,110,0.15);
    border: 1px solid rgba(255,0,110,0.4);
    box-shadow: 0 0 10px rgba(255,0,110,0.2);
  }

  .ai .msg-avatar {
    background: rgba(0,240,255,0.1);
    border: 1px solid rgba(0,240,255,0.4);
    box-shadow: 0 0 10px rgba(0,240,255,0.2);
  }

  .msg-bubble {
    max-width: 75%;
    padding: 12px 16px;
    border-radius: 12px;
    font-size: 0.95rem;
    line-height: 1.6;
    font-family: 'Rajdhani', sans-serif;
    font-weight: 400;
  }

  .user .msg-bubble {
    background: rgba(255,0,110,0.08);
    border: 1px solid rgba(255,0,110,0.25);
    color: #ffd0e0;
    border-radius: 12px 4px 12px 12px;
  }

  .ai .msg-bubble {
    background: rgba(0,240,255,0.05);
    border: 1px solid rgba(0,240,255,0.2);
    color: var(--text);
    border-radius: 4px 12px 12px 12px;
  }

  .msg-label {
    font-family: 'Orbitron', sans-serif;
    font-size: 0.6rem;
    letter-spacing: 2px;
    text-transform: uppercase;
    margin-bottom: 4px;
    opacity: 0.5;
  }

  .thinking-dots {
    display: flex;
    gap: 5px;
    padding: 8px 0;
  }

  .thinking-dots span {
    width: 8px; height: 8px;
    border-radius: 50%;
    background: var(--accent1);
    animation: thinkDot 1.2s ease-in-out infinite;
  }

  .thinking-dots span:nth-child(2) { animation-delay: 0.2s; }
  .thinking-dots span:nth-child(3) { animation-delay: 0.4s; }

  @keyframes thinkDot {
    0%, 100% { opacity: 0.2; transform: scale(0.8); }
    50% { opacity: 1; transform: scale(1.2); }
  }

  .empty-state {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    opacity: 0.3;
    font-family: 'Rajdhani', sans-serif;
    font-size: 0.95rem;
    letter-spacing: 2px;
    text-transform: uppercase;
    text-align: center;
    gap: 10px;
  }

  /* Controls */
  .controls {
    display: flex;
    gap: 12px;
    align-items: center;
    justify-content: center;
    flex-wrap: wrap;
  }

  .btn {
    font-family: 'Orbitron', sans-serif;
    font-size: 0.7rem;
    letter-spacing: 2px;
    text-transform: uppercase;
    padding: 14px 28px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
  }

  .btn::before {
    content: '';
    position: absolute;
    inset: 0;
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .btn:hover::before { opacity: 1; }

  .btn-primary {
    background: rgba(0,240,255,0.1);
    border: 1px solid rgba(0,240,255,0.5);
    color: var(--accent1);
    box-shadow: 0 0 20px rgba(0,240,255,0.1);
    min-width: 180px;
  }

  .btn-primary::before {
    background: rgba(0,240,255,0.1);
  }

  .btn-primary:hover {
    box-shadow: var(--glow1);
    transform: translateY(-2px);
  }

  .btn-primary.active {
    background: rgba(255,0,110,0.15);
    border-color: rgba(255,0,110,0.6);
    color: var(--accent2);
    box-shadow: var(--glow2);
    animation: pulseBtn 1s ease-in-out infinite;
  }

  @keyframes pulseBtn {
    0%, 100% { box-shadow: var(--glow2); }
    50% { box-shadow: 0 0 40px rgba(255,0,110,0.8), 0 0 80px rgba(255,0,110,0.4); }
  }

  .btn-secondary {
    background: rgba(123,47,255,0.1);
    border: 1px solid rgba(123,47,255,0.4);
    color: #b088ff;
  }

  .btn-secondary:hover {
    box-shadow: var(--glow3);
    transform: translateY(-2px);
  }

  .btn-danger {
    background: rgba(255,0,110,0.08);
    border: 1px solid rgba(255,0,110,0.3);
    color: var(--accent2);
  }

  .btn-danger:hover {
    box-shadow: var(--glow2);
    transform: translateY(-2px);
  }

  /* Search indicator */
  .search-indicator {
    display: none;
    align-items: center;
    gap: 8px;
    font-family: 'Rajdhani', sans-serif;
    font-size: 0.85rem;
    color: var(--gold);
    letter-spacing: 1px;
    padding: 8px 16px;
    border: 1px solid rgba(255,215,0,0.2);
    border-radius: 20px;
    background: rgba(255,215,0,0.05);
    margin-bottom: 10px;
  }

  .search-indicator.visible { display: flex; }

  .search-spinner {
    width: 12px; height: 12px;
    border: 2px solid rgba(255,215,0,0.3);
    border-top-color: var(--gold);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  /* Wave visualizer */
  .wave-container {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 4px;
    height: 40px;
    margin: 10px 0;
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .wave-container.active { opacity: 1; }

  .wave-bar {
    width: 4px;
    background: linear-gradient(to top, var(--accent2), var(--accent3));
    border-radius: 2px;
    animation: waveBounce 0.8s ease-in-out infinite;
    height: 8px;
  }

  .wave-bar:nth-child(2) { animation-delay: 0.1s; height: 16px; }
  .wave-bar:nth-child(3) { animation-delay: 0.2s; height: 24px; }
  .wave-bar:nth-child(4) { animation-delay: 0.3s; height: 32px; }
  .wave-bar:nth-child(5) { animation-delay: 0.4s; height: 24px; }
  .wave-bar:nth-child(6) { animation-delay: 0.5s; height: 16px; }
  .wave-bar:nth-child(7) { animation-delay: 0.6s; height: 8px; }

  @keyframes waveBounce {
    0%, 100% { transform: scaleY(0.4); }
    50% { transform: scaleY(1.5); }
  }

  /* Footer */
  .footer {
    text-align: center;
    margin-top: 20px;
    font-family: 'Rajdhani', sans-serif;
    font-size: 0.75rem;
    color: var(--muted);
    letter-spacing: 2px;
    text-transform: uppercase;
    opacity: 0.5;
  }

  /* Particles */
  .particle {
    position: fixed;
    width: 2px; height: 2px;
    border-radius: 50%;
    background: var(--accent1);
    pointer-events: none;
    animation: particleFly linear infinite;
    opacity: 0;
  }

  @keyframes particleFly {
    0% { transform: translateY(100vh) translateX(0); opacity: 0; }
    10% { opacity: 0.8; }
    90% { opacity: 0.4; }
    100% { transform: translateY(-10vh) translateX(var(--dx)); opacity: 0; }
  }

  /* Error */
  .error-msg {
    color: var(--accent2);
    font-size: 0.8rem;
    text-align: center;
    padding: 8px;
    border: 1px solid rgba(255,0,110,0.2);
    border-radius: 8px;
    background: rgba(255,0,110,0.05);
    display: none;
  }

  .error-msg.visible { display: block; }

  /* Transcript input for manual mode */
  .manual-input {
    display: flex;
    gap: 10px;
    align-items: center;
    margin-bottom: 10px;
  }

  .manual-input input {
    flex: 1;
    background: rgba(5,13,24,0.9);
    border: 1px solid rgba(0,240,255,0.2);
    border-radius: 8px;
    padding: 12px 16px;
    color: var(--text);
    font-family: 'Rajdhani', sans-serif;
    font-size: 0.95rem;
    outline: none;
    transition: border-color 0.3s ease;
  }

  .manual-input input:focus {
    border-color: rgba(0,240,255,0.5);
    box-shadow: 0 0 15px rgba(0,240,255,0.1);
  }

  .manual-input input::placeholder { color: var(--muted); opacity: 0.5; }

  @media (max-width: 600px) {
    .orb { width: 120px; height: 120px; }
    .btn { padding: 12px 20px; font-size: 0.6rem; }
  }
</style>
</head>
<body>

<!-- Floating particles -->
<div id="particles"></div>

<div class="container">
  <!-- Header -->
  <div class="header">
    <div class="header-badge">‚ú¶ Powered by AI + Web Search ‚ú¶</div>
    <h1>Samridha's Sirry</h1>
    <p>Your Intelligent Voice Companion</p>
  </div>

  <!-- Orb -->
  <div class="orb-container">
    <div class="orb" id="mainOrb" onclick="toggleListening()">
      <div class="orb-ring"></div>
      <div class="orb-ring"></div>
      <div class="orb-ring"></div>
      <div class="orb-inner"></div>
      <div class="orb-icon" id="orbIcon">üéôÔ∏è</div>
    </div>
  </div>

  <!-- Wave visualizer -->
  <div class="wave-container" id="waveContainer">
    <div class="wave-bar"></div>
    <div class="wave-bar"></div>
    <div class="wave-bar"></div>
    <div class="wave-bar"></div>
    <div class="wave-bar"></div>
    <div class="wave-bar"></div>
    <div class="wave-bar"></div>
  </div>

  <!-- Status -->
  <div class="status-bar">
    <span class="status-dot ready" id="statusDot"></span>
    <span class="status-text" id="statusText">Ready to Listen</span>
  </div>

  <!-- Search indicator -->
  <div class="search-indicator" id="searchIndicator">
    <div class="search-spinner"></div>
    <span>Searching the web for answers...</span>
  </div>

  <!-- Error message -->
  <div class="error-msg" id="errorMsg"></div>

  <!-- Chat area -->
  <div class="chat-area" id="chatArea">
    <div class="empty-state" id="emptyState">
      <span>‚¨°</span>
      <span>Tap the orb or press the button<br>to start speaking</span>
    </div>
  </div>

  <!-- Manual text input -->
  <div class="manual-input">
    <input type="text" id="textInput" placeholder="Or type your question here..." onkeydown="if(event.key==='Enter') sendTextInput()">
    <button class="btn btn-secondary" onclick="sendTextInput()" style="min-width:80px;">Send</button>
  </div>

  <!-- Controls -->
  <div class="controls">
    <button class="btn btn-primary" id="micBtn" onclick="toggleListening()">
      üéôÔ∏è &nbsp;Tap to Speak
    </button>
    <button class="btn btn-secondary" onclick="stopSpeaking()">‚è∏ &nbsp;Stop</button>
    <button class="btn btn-danger" onclick="clearChat()">üóë &nbsp;Clear</button>
  </div>

  <div class="footer">Samridha's Sirry &nbsp;‚Ä¢&nbsp; AI Voice Assistant &nbsp;‚Ä¢&nbsp; 2025</div>
</div>

<script>
// ============================================================
// STATE
// ============================================================
let recognition = null;
let synth = window.speechSynthesis;
let isListening = false;
let isSpeaking = false;
let voices = [];
let preferredVoice = null;
let conversationHistory = [];

// ============================================================
// PARTICLES
// ============================================================
function createParticles() {
  const container = document.getElementById('particles');
  for (let i = 0; i < 20; i++) {
    const p = document.createElement('div');
    p.className = 'particle';
    const dur = 8 + Math.random() * 12;
    const delay = Math.random() * 15;
    const left = Math.random() * 100;
    const dx = (Math.random() - 0.5) * 200;
    const colors = ['#00f0ff','#ff006e','#7b2fff','#ffd700'];
    p.style.cssText = `
      left: ${left}%;
      animation-duration: ${dur}s;
      animation-delay: -${delay}s;
      --dx: ${dx}px;
      background: ${colors[Math.floor(Math.random()*colors.length)]};
      width: ${1+Math.random()*3}px;
      height: ${1+Math.random()*3}px;
    `;
    container.appendChild(p);
  }
}
createParticles();

// ============================================================
// VOICE SETUP
// ============================================================
function loadVoices() {
  voices = synth.getVoices();
  // Prefer a clear female English voice
  const prefNames = ['Samantha', 'Karen', 'Victoria', 'Moira', 'Google UK English Female', 'Microsoft Zira', 'Google US English'];
  for (const name of prefNames) {
    const found = voices.find(v => v.name.includes(name));
    if (found) { preferredVoice = found; break; }
  }
  if (!preferredVoice) {
    preferredVoice = voices.find(v => v.lang.startsWith('en') && v.name.toLowerCase().includes('female'))
      || voices.find(v => v.lang.startsWith('en'))
      || voices[0];
  }
}

synth.onvoiceschanged = loadVoices;
loadVoices();

// ============================================================
// SPEECH RECOGNITION SETUP
// ============================================================
function setupRecognition() {
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SpeechRecognition) return null;
  const r = new SpeechRecognition();
  r.continuous = false;
  r.interimResults = true;
  r.lang = 'en-US';

  r.onstart = () => {
    setStatus('listening', 'üî¥ Listening...', 'listening');
    setOrbState('listening');
    document.getElementById('waveContainer').classList.add('active');
    document.getElementById('micBtn').classList.add('active');
    document.getElementById('micBtn').innerHTML = 'üî¥ &nbsp;Listening...';
  };

  r.onresult = (e) => {
    const transcript = Array.from(e.results).map(r => r[0].transcript).join('');
    if (e.results[e.results.length - 1].isFinal) {
      stopListeningUI();
      processQuery(transcript);
    }
  };

  r.onerror = (e) => {
    stopListeningUI();
    let msg = 'Mic error. Please allow microphone access or use text input.';
    if (e.error === 'not-allowed') msg = 'Microphone access denied. Please allow it in browser settings.';
    else if (e.error === 'no-speech') msg = 'No speech detected. Try again!';
    showError(msg);
    setStatus('ready', 'Ready to Listen', 'ready');
  };

  r.onend = () => {
    if (isListening) {
      stopListeningUI();
    }
  };

  return r;
}

// ============================================================
// UI HELPERS
// ============================================================
function setStatus(dot, text, dotClass) {
  const d = document.getElementById('statusDot');
  d.className = 'status-dot ' + dotClass;
  document.getElementById('statusText').textContent = text;
  document.getElementById('statusText').className = 'status-text active';
}

function setOrbState(state) {
  const orb = document.getElementById('mainOrb');
  const icon = document.getElementById('orbIcon');
  orb.className = 'orb ' + state;
  if (state === 'listening') icon.textContent = 'üéôÔ∏è';
  else if (state === 'speaking') icon.textContent = 'üîä';
  else if (state === 'thinking') icon.textContent = '‚ú¶';
  else icon.textContent = 'üéôÔ∏è';
}

function showError(msg) {
  const el = document.getElementById('errorMsg');
  el.textContent = msg;
  el.classList.add('visible');
  setTimeout(() => el.classList.remove('visible'), 5000);
}

function stopListeningUI() {
  isListening = false;
  document.getElementById('waveContainer').classList.remove('active');
  document.getElementById('micBtn').classList.remove('active');
  document.getElementById('micBtn').innerHTML = 'üéôÔ∏è &nbsp;Tap to Speak';
}

function removeEmptyState() {
  const el = document.getElementById('emptyState');
  if (el) el.remove();
}

// ============================================================
// CHAT MESSAGES
// ============================================================
function addMessage(role, text) {
  removeEmptyState();
  const chat = document.getElementById('chatArea');
  const wrap = document.createElement('div');
  wrap.className = `message ${role}`;

  const avatar = document.createElement('div');
  avatar.className = 'msg-avatar';
  avatar.textContent = role === 'user' ? 'üë§' : '‚ú¶';

  const bubble = document.createElement('div');
  bubble.className = 'msg-bubble';

  const label = document.createElement('div');
  label.className = 'msg-label';
  label.textContent = role === 'user' ? 'You' : 'Sirry';

  bubble.appendChild(label);
  bubble.appendChild(document.createTextNode(text));

  wrap.appendChild(avatar);
  wrap.appendChild(bubble);
  chat.appendChild(wrap);
  chat.scrollTop = chat.scrollHeight;
  return wrap;
}

function addThinking() {
  removeEmptyState();
  const chat = document.getElementById('chatArea');
  const wrap = document.createElement('div');
  wrap.className = 'message ai';
  wrap.id = 'thinkingMsg';

  const avatar = document.createElement('div');
  avatar.className = 'msg-avatar';
  avatar.textContent = '‚ú¶';

  const bubble = document.createElement('div');
  bubble.className = 'msg-bubble';

  const dots = document.createElement('div');
  dots.className = 'thinking-dots';
  dots.innerHTML = '<span></span><span></span><span></span>';
  bubble.appendChild(dots);

  wrap.appendChild(avatar);
  wrap.appendChild(bubble);
  chat.appendChild(wrap);
  chat.scrollTop = chat.scrollHeight;
}

function removeThinking() {
  const el = document.getElementById('thinkingMsg');
  if (el) el.remove();
}

// ============================================================
// CONTROLS
// ============================================================
function toggleListening() {
  if (isSpeaking) { stopSpeaking(); return; }
  if (isListening) {
    if (recognition) recognition.stop();
    stopListeningUI();
    setStatus('ready', 'Ready to Listen', 'ready');
    setOrbState('');
    return;
  }
  recognition = setupRecognition();
  if (!recognition) {
    showError('Speech recognition not supported in this browser. Please use Chrome or Edge, or type your question below.');
    return;
  }
  isListening = true;
  recognition.start();
}

function stopSpeaking() {
  synth.cancel();
  isSpeaking = false;
  setOrbState('');
  setStatus('ready', 'Ready to Listen', 'ready');
  document.getElementById('waveContainer').classList.remove('active');
}

function clearChat() {
  stopSpeaking();
  conversationHistory = [];
  const chat = document.getElementById('chatArea');
  chat.innerHTML = '<div class="empty-state" id="emptyState"><span>‚¨°</span><span>Tap the orb or press the button<br>to start speaking</span></div>';
  setStatus('ready', 'Ready to Listen', 'ready');
  setOrbState('');
}

function sendTextInput() {
  const input = document.getElementById('textInput');
  const query = input.value.trim();
  if (!query) return;
  input.value = '';
  processQuery(query);
}

// ============================================================
// AI PROCESSING WITH WEB SEARCH VIA CLAUDE API
// ============================================================
async function processQuery(query) {
  if (!query) return;
  addMessage('user', query);
  addThinking();
  setStatus('thinking', '‚ú¶ Thinking...', 'thinking');
  setOrbState('thinking');

  // Check if query needs web search
  const needsSearch = detectNeedsSearch(query);

  let contextInfo = '';

  if (needsSearch) {
    document.getElementById('searchIndicator').classList.add('visible');
    try {
      contextInfo = await performWebSearch(query);
    } catch (e) {
      console.warn('Search failed:', e);
    }
    document.getElementById('searchIndicator').classList.remove('visible');
  }

  // Build system prompt
  const systemPrompt = `You are Sirry ‚Äî Samridha's intelligent, warm, and witty AI voice assistant. You are helpful, concise, and conversational. 
When speaking, keep responses natural and not too long (ideal for text-to-speech ‚Äî under 100 words unless detail is needed). 
Be friendly, engaging, and smart. If web search context is provided, use it accurately.
Always respond in clear, spoken English.`;

  const userMessage = contextInfo
    ? `User question: "${query}"\n\nWeb search results for context:\n${contextInfo}\n\nPlease answer the question using this information.`
    : query;

  conversationHistory.push({ role: 'user', content: userMessage });

  try {
    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 1000,
        system: systemPrompt,
        messages: conversationHistory
      })
    });

    const data = await response.json();
    const answer = data.content?.map(b => b.text || '').join('') || "I'm sorry, I couldn't get a response right now.";

    conversationHistory.push({ role: 'assistant', content: answer });

    removeThinking();
    addMessage('ai', answer);
    speak(answer);
  } catch (err) {
    removeThinking();
    const fallback = "I'm having trouble connecting right now. Please check your internet connection and try again.";
    addMessage('ai', fallback);
    speak(fallback);
    console.error(err);
  }
}

// ============================================================
// WEB SEARCH via DuckDuckGo Instant Answer API (CORS-friendly)
// ============================================================
function detectNeedsSearch(query) {
  const searchTriggers = [
    'what is', 'who is', 'how to', 'when did', 'where is', 'why does',
    'latest', 'news', 'current', 'today', 'price', 'weather', 'score',
    'define', 'meaning', 'explain', 'tell me about', 'search', 'find',
    '2024', '2025', '2026', 'recent', 'best', 'top', 'list of'
  ];
  const q = query.toLowerCase();
  return searchTriggers.some(t => q.includes(t));
}

async function performWebSearch(query) {
  try {
    // Use DuckDuckGo Instant Answer API (no key needed, CORS allowed)
    const url = `https://api.duckduckgo.com/?q=${encodeURIComponent(query)}&format=json&no_html=1&skip_disambig=1`;
    const res = await fetch(url);
    const data = await res.json();

    let context = '';
    if (data.AbstractText) context += `Summary: ${data.AbstractText}\n`;
    if (data.Answer) context += `Answer: ${data.Answer}\n`;
    if (data.Definition) context += `Definition: ${data.Definition}\n`;
    if (data.RelatedTopics && data.RelatedTopics.length > 0) {
      const topics = data.RelatedTopics.slice(0, 3).map(t => t.Text).filter(Boolean).join('\n');
      if (topics) context += `Related info:\n${topics}\n`;
    }
    return context || '';
  } catch (e) {
    console.warn('DuckDuckGo search failed:', e);
    return '';
  }
}

// ============================================================
// TEXT TO SPEECH
// ============================================================
function speak(text) {
  if (!text || !synth) return;
  synth.cancel();

  // Clean text for TTS
  const cleanText = text.replace(/[*_#`]/g, '').trim();

  const utterance = new SpeechSynthesisUtterance(cleanText);
  utterance.rate = 0.95;
  utterance.pitch = 1.05;
  utterance.volume = 1;

  if (preferredVoice) utterance.voice = preferredVoice;
  else loadVoices();

  utterance.onstart = () => {
    isSpeaking = true;
    setStatus('speaking', 'üîä Speaking...', 'speaking');
    setOrbState('speaking');
    document.getElementById('waveContainer').classList.add('active');
  };

  utterance.onend = () => {
    isSpeaking = false;
    setStatus('ready', 'Ready to Listen', 'ready');
    setOrbState('');
    document.getElementById('waveContainer').classList.remove('active');
  };

  utterance.onerror = () => {
    isSpeaking = false;
    setStatus('ready', 'Ready to Listen', 'ready');
    setOrbState('');
    document.getElementById('waveContainer').classList.remove('active');
  };

  // iOS fix
  setTimeout(() => synth.speak(utterance), 100);
}

// ============================================================
// WELCOME MESSAGE
// ============================================================
window.addEventListener('load', () => {
  setTimeout(() => {
    const welcome = "Hello! I'm Sirry, Samridha's AI assistant. I can answer your questions, search the web, and help you with almost anything. Just tap the orb or the button to start speaking!";
    addMessage('ai', welcome);
    speak(welcome);
  }, 1200);
});

// Keyboard shortcut: Space to toggle mic
document.addEventListener('keydown', (e) => {
  if (e.code === 'Space' && e.target.tagName !== 'INPUT') {
    e.preventDefault();
    toggleListening();
  }
});
</script>
</body>
</html>
